description: |
  - Tag validation (only image-version tags like X.Y.Z allowed)
  - Docker image build and tagging
  - Image push to target registry
  - Security scan using Trivy
  - Report generation and artifact upload
  - Slack notification for delivery completion

inputs:
  docker_user:
    required: true
    description: "Username or service account used to authenticate to the Docker registry."
  docker_token:
    required: true
    description: "Access token or password used for Docker registry authentication."
  docker_repo:
    required: true
    description: "Target Docker registry repository or namespace to push the built image."
  slack:
    required: true
    description: "Incoming Slack Webhook URL used to send delivery status notifications."

runs:
  using: composite
  steps:
    # ==========================================================
    # ğŸ§¾ STEP 1: Validate and Parse
    # Ensures only tags like "X.Y.Z" trigger delivery.
    # ==========================================================
    - name: ğŸ” Validate Branch & Parse Tag
      id: parse
      shell: bash
      run: |
        BRANCH="${GITHUB_REF_NAME}"
        TAG="${GITHUB_REF#refs/tags/}"
        echo "ğŸ§© Branch: $BRANCH"
        echo "ğŸ·ï¸ Tag: $TAG"
        if [[ ! "$BRANCH" =~ ^release/([a-z0-9\-]+)/([a-z0-9\-]+)$ ]]; then
          echo "âŒ Invalid branch format. Expected: release/<scope>/<module>"
          exit 1
        fi
        SCOPE="${BASH_REMATCH[1]}"
        MODULE="${BASH_REMATCH[2]}"
        IMAGE="${SCOPE}/${MODULE}"
        echo "ğŸ”¹ Extracted SCOPE: $SCOPE"
        echo "ğŸ”¹ Extracted MODULE: $MODULE"
        echo "ğŸ”¹ Image path: $IMAGE"
        if [[ ! "$TAG" =~ ^([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
          echo "âŒ Invalid tag format. Expected: X.Y.Z (e.g. 1.2.3)"
          exit 1
        fi
        VERSION="${BASH_REMATCH[1]}"
        echo "âœ… Tag validation passed"
        echo "ğŸ”¹ Extracted VERSION: $VERSION"
        {
          echo "scope=$SCOPE"
          echo "module=$MODULE"
          echo "image=$IMAGE"
          echo "version=$VERSION"
        } >> "$GITHUB_OUTPUT"

    # ==========================================================
    # ğŸ—ï¸ STEP 2: Build Docker image
    # Builds the Docker image using its module directory.
    # ==========================================================
    - name: ğŸ—ï¸ Build Docker Image
      shell: bash
      run: |
        IMAGE_NAME="${{ inputs.docker_repo }}/${{ steps.parse.outputs.image }}:${{ steps.parse.outputs.version }}"
        SCOPE="${{ steps.parse.outputs.scope }}"
        MODULE="${{ steps.parse.outputs.module }}"
        echo "ğŸ—ï¸ Building Docker image: $IMAGE_NAME"
        echo "ğŸ“¦ Scope: $SCOPE | Module: $MODULE"
        docker build \
          -t "$IMAGE_NAME" \
          -f ".docker/Dockerfile" \
          --build-arg SCOPE="$SCOPE" \
          --build-arg MODULE="$MODULE" \
          .
        echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV

    # ==========================================================
    # ğŸš€ STEP 3: Push Docker image
    # Authenticates and pushes the image to the target registry.
    # ==========================================================
    - name: ğŸš€ Push Docker Image
      shell: bash
      run: |
        echo "${{ inputs.docker_token }}" | docker login -u "${{ inputs.docker_user }}" --password-stdin
        docker push "$IMAGE_NAME"

    # ==========================================================
    # ğŸ›¡ï¸ STEP 4: Scan Docker image vulnerabilities
    # ==========================================================
    - name: ğŸ›¡ï¸ Scan Docker Image (Trivy)
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: ${{ env.IMAGE_NAME }}
        severity: HIGH,CRITICAL
        ignore-unfixed: true
        exit-code: 1

    # ==========================================================
    # ğŸ§¾ STEP 5: Generate build report
    # ==========================================================
    - name: ğŸ§¾ Generate Delivery Report
      shell: bash
      run: |
        DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$IMAGE_NAME")
        echo "DIGEST=$DIGEST" >> $GITHUB_ENV
        echo "âœ… Build completed for $IMAGE_NAME" > report.txt
        echo "ğŸ”‘ Digest: $DIGEST" >> report.txt

    # ==========================================================
    # ğŸ“¦ STEP 6: Upload delivery artifacts
    # ==========================================================
    - name: ğŸ“¤ Upload Delivery Report
      uses: actions/upload-artifact@v4
      with:
        name: release-report-${{ steps.parse.outputs.image }}-${{ steps.parse.outputs.version }}
        path: report.txt

    # ==========================================================
    # ğŸ“£ STEP 7: Notify Slack channel
    # ==========================================================
    - name: ğŸ“£ Notify Slack (Delivery Complete)
      shell: bash
      env:
        WEBHOOK_URL: ${{ inputs.slack }}
      run: |
        MESSAGE="âœ… CD Delivery completed successfully for tag: $GITHUB_REF_NAME"
        MESSAGE="$MESSAGE\nğŸ“¦ Image: ${{ steps.parse.outputs.image }}:${{ steps.parse.outputs.version }}"
        curl -X POST -H "Content-Type: application/json" \
          --data "{\"text\":\"$MESSAGE\"}" $WEBHOOK_URL
