description: |
  - Dependency caching
  - Static & Security analysis
  - Testing & Building
  - Artifact upload
  - Aggregate validation
  - Image pre-build & vulnerability scan

inputs:
  scope:
    description: "Java Spring Boot independent application"
    required: true
  service:
    description: "A Service belong to Scope"
    required: true

runs:
  using: composite
  steps:
    # ==========================================================
    # ☕ STEP 1: Setup Java environment
    # Sets up Temurin JDK 25 for Gradle build and test execution.
    # ==========================================================
    - name: ⚙️ Setup Java 25 (Temurin)
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'

    # ==========================================================
    # 🚀 STEP 2: Restore Gradle cache
    # Restores previously cached Gradle dependencies and wrapper
    # to speed up build times and reduce redundant downloads.
    # ==========================================================
    - name: 💾 Restore Gradle Cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    # ==========================================================
    # 🔍 STEP 3: Static code analysis
    # Runs Gradle `check` task (includes lint, static analysis, etc.)
    # to detect style and potential issues early.
    # ==========================================================
    - name: 🧠 Static Code Analysis
      shell: bash
      run: ./gradlew :${{ inputs.scope }}:${{ inputs.service }}:check

    # ==========================================================
    # 🛡️ STEP 4: Dependency vulnerability scan
    # Uses Anchore to scan dependencies for known vulnerabilities.
    # Build will fail on findings with severity ≥ HIGH.
    # ==========================================================
    - name: 🧩 Dependency Security Scan
      shell: bash
      working-directory: ./${{ inputs.scope }}/${{ inputs.service }}
      run: ./gradlew dependencies --configuration runtimeClasspath > deps.txt

    - uses: anchore/scan-action@v4
      with:
        path: ./${{ inputs.scope }}/${{ inputs.service }}/deps.txt
        fail-build: true
        severity-cutoff: high

    # ==========================================================
    # 🧪 STEP 5: Run tests and build service
    # Executes unit tests, integration tests, and generates coverage report.
    # ==========================================================
    - name: 🧪 Test, Build & Coverage
      shell: bash
      env:
        SPRING_PROFILES_ACTIVE: test
      run: ./gradlew :${{ inputs.scope }}:${{ inputs.service }}:clean build jacocoTestReport

    # ==========================================================
    # 📊 STEP 6: Upload test report artifact
    # Stores test result reports as GitHub Action artifacts for later review.
    # ==========================================================
    - name: 📤 Upload Test Report
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.scope }}-${{ inputs.service }}-test-report
        path: ${{ inputs.scope }}/${{ inputs.service }}/build/reports/tests/test

    # ==========================================================
    # 📈 STEP 7: Upload code coverage report
    # Publishes generated JaCoCo coverage report as build artifact.
    # ==========================================================
    - name: 📤 Upload Coverage Report
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.scope }}-${{ inputs.service }}-coverage-report
        path: ${{ inputs.scope }}/${{ inputs.service }}/build/reports/jacoco/test/html

    # ==========================================================
    # 🧱 STEP 8: Pre-build Docker image (build stage only)
    # Builds an intermediate image targeting the 'build' stage to validate
    # Dockerfile integrity and dependencies without producing the final artifact.
    # ==========================================================
    - name: 🐳 Pre-Build Docker Image
      shell: bash
      run: |
        docker build \
          --target build \
          -t ci-${{ inputs.scope }}-${{ inputs.service }}:prebuild \
          -f .docker/Dockerfile \
          --build-arg SCOPE="${{ inputs.scope }}" \
          --build-arg SERVICE="${{ inputs.service }}" \
          .

    # ==========================================================
    # 🔬 STEP 9: Container image vulnerability scan
    # Scans the pre-built Docker image for OS and dependency vulnerabilities
    # using Trivy, failing on HIGH or CRITICAL findings.
    # ==========================================================
    - name: 🔬 Scan Docker Image (Trivy)
      uses: aquasecurity/trivy-action@0.20.0
      with:
        image-ref: ci-${{ inputs.scope }}-${{ inputs.service }}:prebuild
        severity: HIGH,CRITICAL
        ignore-unfixed: true
        exit-code: 1
